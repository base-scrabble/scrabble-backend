name: Fly Keepalive

on:
  schedule:
    # GitHub scheduled workflows run at best-effort granularity (typically >= 5 minutes)
    - cron: '*/5 * * * *'
  workflow_dispatch: {}

concurrency:
  group: fly-keepalive
  cancel-in-progress: true

jobs:
  ping:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Ping backend health/diag
        shell: bash
        run: |
          set -euo pipefail
          BASE_URL="https://basescrabble-backend.fly.dev"

          for path in "/api/health" "/api/diag"; do
            url="${BASE_URL}${path}"
            echo "Pinging ${url}"
            # Don't use -f: even a 503/HTML response still warms the instance.
            # Do retry on transient network/timeouts.
            curl -sS -m 30 \
              --retry 3 \
              --retry-all-errors \
              --retry-delay 3 \
              -H "Cache-Control: no-cache" \
              -H "X-Client-Request-Id: keepalive-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}" \
              "${url}" \
              | head -c 500
            echo ""
          done